#!/bin/bash

function usage {
  echo "Usage: $0 
  -l | --location, HDFS directory of files generated by gen-data.sh.
  -t | --textdb, The flat database's name.
  -c | --command, Query exec command.
  -h | --help, show this help text."
}

while [ $# -gt 0 ]; do
  case "$1" in
    -l | --location)
      shift
      LOCATION_HDFS=$1
      shift
      ;;
    -t | --textdb)
      shift
      TEXT_DB=$1
      shift
      ;;
    -c | --command)
      shift
      EXEC_COMMAND=$1
      shift
      ;;
    -h | --help)
      HELP=true
      shift
      ;;
    *)
      echo "Invalid args: $1"
      exit 1
      ;;
  esac
done

[ X"$HELP" == X"true" ] && usage && exit 1

# Tables in the TPC-DS schema.
LIST="date_dim time_dim item customer customer_demographics 
      household_demographics customer_address store promotion 
      warehouse ship_mode reason income_band call_center 
      web_page catalog_page inventory store_sales store_returns
      web_sales web_returns web_site catalog_sales catalog_returns"

if [ X"$LOCATION_HDFS" == "X" ]; then
  # Default location in hdfs.
  usage && exit 1
fi
hdfs dfs -ls ${LOCATION_HDFS}/${TPCDS_SCALE} > /dev/null 2>&1
if [ $? -ne 0 ]; then 
  echo "Flat files in hdfs not exist, run gen-data.sh first."
  exit 1
fi

# Generate the text tables, which will be later converted to formatted table.
if [ 'X'$INTEGRATE_MODE != "Xtrue" ]; then
  read -p "You are creating tpcds flat tables base on the data stored at HDFS \
directory ${LOCATION_HDFS}/${TPCDS_SCALE}, and the database name is $TEXT_DB, \
is that OK [Yes|No]? " CONFIRM 
  [ 'X'$CONFIRM != "XYes" ] && echo "Your answer is not Yes, check tpcds-env.sh and run again." && exit 1
fi

for t in ${LIST}; do
  echo "Creating table $t..."
  $EXEC_COMMAND -i $PROJ_HOME/settings/load-flat.sql -f $PROJ_HOME/ddl/text/${t}.sql -d DB=$TEXT_DB -d LOCATION=${LOCATION_HDFS}/${TPCDS_SCALE}/${t} > /dev/null 2>&1
done
